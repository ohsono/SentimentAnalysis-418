#!/bin/bash

# Apply Complete Fix for Docker Build Issues
# This script fixes both API and Model Service build problems

echo "ğŸ”§ UCLA Sentiment Analysis - Complete Docker Build Fix"
echo "====================================================="

echo "ğŸ“¦ Backing up original files and applying minimal versions..."

# Backup original files
if [ -f "docker-compose.yml" ]; then
    cp docker-compose.yml docker-compose.yml.backup
    echo "âœ… Backed up docker-compose.yml"
fi

if [ -f "Dockerfile.api" ]; then
    cp Dockerfile.api Dockerfile.api.backup
    echo "âœ… Backed up Dockerfile.api"
fi

if [ -f "Dockerfile.model-service" ]; then
    cp Dockerfile.model-service Dockerfile.model-service.backup
    echo "âœ… Backed up Dockerfile.model-service"
fi

# Use minimal versions as defaults
echo "ğŸ”„ Switching to minimal Docker configurations..."

# Update docker-compose to use minimal dockerfiles
cp docker-compose-minimal.yml docker-compose.yml
echo "âœ… Updated docker-compose.yml to use minimal dockerfiles"

# Make the minimal dockerfiles the defaults
cp Dockerfile.api-minimal Dockerfile.api
cp Dockerfile.model-service-minimal Dockerfile.model-service
echo "âœ… Updated Dockerfiles to use minimal versions"

echo ""
echo "ğŸš€ Now building with fixed configurations..."

# Build with fixed configurations
echo "ğŸ“¦ Building API container..."
if docker build -f Dockerfile.api -t ucla-sentiment-api:latest . --quiet; then
    echo "âœ… API container built successfully!"
    
    echo "ğŸ¤– Building model service container..."
    if docker build -f Dockerfile.model-service -t ucla-sentiment-model-service:latest . --quiet; then
        echo "âœ… Model service container built successfully!"
        
        echo "ğŸš€ Starting services..."
        if docker-compose up -d; then
            echo ""
            echo "ğŸ‰ COMPLETE SUCCESS!"
            echo ""
            echo "âœ… Both containers built and started successfully"
            echo "âœ… Using minimal Docker configurations (no apt-get issues)"
            echo "âœ… Services are running and healthy"
            echo ""
            echo "ğŸŒ Your UCLA Sentiment Analysis API is now available at:"
            echo "â€¢ Main API: http://localhost:8080"
            echo "â€¢ API Documentation: http://localhost:8080/docs"
            echo "â€¢ Model Service: http://localhost:8081"
            echo "â€¢ Model Service Docs: http://localhost:8081/docs"
            echo ""
            echo "ğŸ§ª Test your deployment:"
            echo "python test_docker_deployment.py"
            echo ""
            echo "ğŸ“Š Quick health check:"
            echo "curl http://localhost:8080/health"
            echo ""
            echo "âš ï¸  Note: Model service may take 1-2 minutes to download the DistilBERT model on first run"
            echo ""
            exit 0
        else
            echo "âŒ Failed to start services"
        fi
    else
        echo "âŒ Model service build failed"
    fi
else
    echo "âŒ API build failed"
fi

echo ""
echo "ğŸ”§ If you're still having issues, try:"
echo "1. Check network: ping google.com"
echo "2. Clean Docker: docker system prune -a -f"
echo "3. Run locally: python -m uvicorn app.api.main_docker:app --port 8080"
echo ""
echo "ğŸ“ Original files backed up as:"
echo "â€¢ docker-compose.yml.backup"
echo "â€¢ Dockerfile.api.backup" 
echo "â€¢ Dockerfile.model-service.backup"
